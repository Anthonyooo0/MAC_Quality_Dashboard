name: Email Sync

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hour max

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Download existing database
        run: |
          # Try to download complaints.db from the data branch
          git fetch origin data --depth=1 2>/dev/null || true
          if git show origin/data:complaints.db > /dev/null 2>&1; then
            git show origin/data:complaints.db > complaints.db
            echo "Downloaded existing complaints.db from data branch"
            python -c "import sqlite3; con=sqlite3.connect('complaints.db'); cur=con.cursor(); cur.execute('SELECT COUNT(*) FROM complaints'); print(f'Existing complaints: {cur.fetchone()[0]}'); con.close()"
          else
            echo "No existing database found, starting fresh"
          fi

      - name: Run email sync
        env:
          HEADLESS: "true"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          MSAL_TOKEN_CACHE: ${{ secrets.MSAL_TOKEN_CACHE }}
          MAILBOX: ${{ secrets.MAILBOX }}
          START_DATE: ${{ secrets.START_DATE }}
        run: |
          python main.py

      - name: Show results
        run: |
          python -c "
          import sqlite3
          con = sqlite3.connect('complaints.db')
          cur = con.cursor()
          cur.execute('SELECT COUNT(*) FROM complaints')
          print(f'Total complaints in database: {cur.fetchone()[0]}')
          cur.execute('SELECT category, COUNT(*) FROM complaints GROUP BY category ORDER BY COUNT(*) DESC')
          for row in cur.fetchall():
              print(f'  {row[0]}: {row[1]}')
          con.close()
          "

      - name: Push database to data branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or switch to data branch
          git checkout --orphan data-temp 2>/dev/null || git checkout -B data-temp
          git rm -rf . 2>/dev/null || true

          # Add only the database file
          cp complaints.db . 2>/dev/null || true
          git add complaints.db

          # Commit and force push to data branch
          git commit -m "Update complaints database $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"
          git push origin HEAD:data --force
